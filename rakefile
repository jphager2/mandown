require 'rake'
require 'active_record'

task :test do
  puts `rspec ./spec/`
end

namespace :db do
  config = {
    "username"  => ENV["PG_USER"],
    "password"  => ENV["PG_PASS"],
    "database"  => 'mangdown',
    "pool"      => "5",
    "reconnect" => "false",
    "encoding"  => "utf-8",
    "adapter"   => "postgresql",
  }

  def establish_base_connection(config)
    ActiveRecord::Base.establish_connection(
      config.merge(
        {
          "database" => "postgres",
          "schema_search_path" => "public",
        }
      )
    )
  end

  def establish_connection(config)
    ActiveRecord::Base.establish_connection(config)
  end 
    
  task :create do
    establish_base_connection(config) 
    ActiveRecord::Base.connection.create_database(
      config["database"],
      config,
    )
  end

  task :drop do
    establish_base_connection(config) 

    ActiveRecord::Base.connection.drop_database(
      config["database"],
    )
  end

  task :migrate do
    establish_connection(config)
    ActiveRecord::Migrator.migrate('db/migrate', nil)
  end
end

task default: [:test]

